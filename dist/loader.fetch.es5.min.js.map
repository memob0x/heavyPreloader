{"version":3,"sources":["loader.fetch.mjs"],"names":["ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","obj","value","configurable","writable","_classCallCheck","instance","Constructor","TypeError","_defineProperties","props","descriptor","_createClass","protoProps","staticProps","prototype","asyncGeneratorStep","gen","resolve","reject","_next","_throw","arg","info","error","done","Promise","then","_asyncToGenerator","fn","self","this","args","err","undefined","_typeof","Symbol","iterator","constructor","global","factory","exports","module","define","amd","Loader","createFetchWorker","body","onmessage","_ref","regeneratorRuntime","mark","_callee","event","response","blob","wrap","_context","prev","next","fetch","data","href","options","sent","status","statusText","t0","postMessage","stop","_x","url","URL","createObjectURL","Blob","toString","type","worker","Worker","revokeObjectURL","lworker","LoaderWorker","_worker","_requests","terminate","LoaderFetch","cache","_fetch","_callee2","_context2","abrupt","addEventListener","Error","concat","_x2","_x3"],"mappings":"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","sourcesContent":["(function (global, factory) {\n    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :\n    typeof define === 'function' && define.amd ? define('Loader', factory) :\n    (global = global || self, global.Loader = factory());\n}(this, (function () { 'use strict';\n\n    /**\n     *\n     * @private\n     * @static\n     * TODO: provide unit test\n     */\n    const createDynamicWorker = (body) => {\n        // ...\n        const url = URL.createObjectURL(\n            new Blob([\"(\", body.toString(), \")()\"], {\n                type: \"application/javascript\",\n            })\n        );\n\n        // ...\n        const worker = new Worker(url);\n\n        // ...\n        URL.revokeObjectURL(url);\n\n        // ...\n        return worker;\n    };\n\n    /**\n     *\n     * @private\n     * @static\n     * TODO: provide unit test\n     */\n    const createFetchWorker = () =>\n        createDynamicWorker(\n            () =>\n                (onmessage = async (event) => {\n                    //\n                    try {\n                        const response = await fetch(\n                            event.data.href,\n                            event.data.options\n                        );\n                        const blob = await response.blob();\n\n                        event.data.status = response.status;\n                        event.data.statusText = response.statusText;\n                        event.data.blob = blob;\n                    } catch (e) {\n                        event.data.statusText = e;\n                    }\n\n                    // ...\n                    postMessage(event.data);\n                })\n        );\n\n    /**\n     *\n     */\n    var lworker = new (class LoaderWorker {\n        constructor() {\n            this._worker = null;\n\n            this._requests = 0;\n        }\n\n        terminate() {\n            //\n            //\n            if (this._requests > 0) {\n                this._requests--;\n            }\n\n            //\n            if (this._requests === 0) {\n                this._worker.terminate();\n\n                this._worker = null;\n            }\n\n            //\n            return this._worker;\n        }\n\n        worker() {\n            // ...\n            this._requests++;\n\n            // ...\n            if (this._worker) {\n                return this._worker;\n            }\n\n            // ...\n            this._worker = createFetchWorker();\n\n            //\n            return this._worker;\n        }\n    })();\n\n    /**\n     *\n     */\n    var loader_fetch = new (class LoaderFetch {\n        constructor() {\n            // ...\n            this.cache = {};\n        }\n\n        /**\n         * Fetches a resource url in the secondary thread and retrieves it as a blob\n         * @private\n         * @param {String} href The resource url to be fetched\n         * @param {Object} options The fetch options object\n         * @returns {Promise} The fetch promise\n         */\n        async fetch(href, options) {\n            // ...\n            options = {\n                ...{\n                    cache: true,\n                    fetch: {},\n                },\n                ...options,\n            };\n\n            // ...\n            if (options.cache === true && href in this.cache) {\n                return await this.cache[href];\n            }\n\n            // ...\n            return (this.cache[href] = new Promise((resolve, reject) => {\n                //\n                const worker = lworker.worker();\n\n                // ...\n                worker.postMessage({\n                    href: href,\n                    options: options.fetch,\n                });\n\n                // ...\n                // TODO: possibly use messageerror for reject?\n                worker.addEventListener(\"message\", (event) => {\n                    const data = event.data;\n\n                    // ...\n                    if (data.href !== href) {\n                        return;\n                    }\n\n                    //\n                    lworker.terminate();\n\n                    // ...\n                    if (data.status === 200) {\n                        resolve(data.blob);\n\n                        return;\n                    }\n\n                    // ...\n                    reject(\n                        new Error(`${data.statusText} for ${data.href} resource.`)\n                    );\n                });\n            }));\n        }\n    })();\n\n    return loader_fetch;\n\n})));\n"],"file":"loader.fetch.es5.min.js"}