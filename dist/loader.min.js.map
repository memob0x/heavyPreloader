{"version":3,"sources":["src/loader.utils.mjs","src/loader.loaders.mjs","src/loader.worker.mjs","src/loader.mjs"],"names":["global","factory","exports","module","define","amd","self","Loader","this","parseUrl","url","a","document","createElement","href","urlFromDataObject","data","blob","type","URL","createObjectURL","response","getLoaderTypeFromUrl","isCORSUrl","host","window","location","image","attributeName","el","Image","Promise","resolve","reject","onload","onerror","setAttribute","style","sheet","CSSStyleSheet","promise","replace","adoptedStyleSheets","script","tagName","preload","i","width","height","body","append","object","src","async","head","Loaders","Object","freeze","__proto__","worker","onmessage","event","fetch","status","statusText","e","postMessage","[object Object]","options","Worker","Blob","toString","_options","parsedUrl","defaultData","then","catch","addEventListener","Error","finally","revokeObjectURL","name","loader","querySelectorAll","forEach","dataset","x","setImageAttribute","console","error","adoptStyleSheet","insertScript","defineProperty","value"],"mappings":"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","sourcesContent":["/**\n *\n * @param url\n */\nexport const parseUrl = url => {\n    const a = document.createElement(\"a\");\n    a.href = url;\n    return a;\n};\n\n/**\n *\n * @param data\n */\nexport const urlFromDataObject = data =>\n    data.blob.type ? URL.createObjectURL(data.blob) : data.response.url;\n\n/**\n * TODO: do it\n * @param url\n */\nexport const getLoaderTypeFromUrl = url => \"image\";\n\n/**\n *\n * @param url\n */\nexport const isCORSUrl = url => url.host !== window.location.host;\n","export const image = (url, attributeName = \"src\", el = new Image()) =>\n    new Promise((resolve, reject) => {\n        el.onload = resolve;\n        el.onerror = reject;\n\n        el.setAttribute(attributeName, url);\n    });\n\nexport const style = (url, el = document.createElement(\"div\")) => {\n    const sheet = new CSSStyleSheet();\n\n    const promise = sheet.replace(`@import url(\"${url}\")`);\n\n    if (\"adoptedStyleSheets\" in el) {\n        el.adoptedStyleSheets = [...el.adoptedStyleSheets, sheet];\n    }\n\n    return promise;\n};\n\nconst object = (url, el) =>\n    new Promise((resolve, reject) => {\n        el.onload = resolve;\n        el.onerror = reject;\n\n        el.data = preload[i];\n\n        el.width = 0;\n        el.height = 0;\n\n        document.body.append(el);\n    });\n\nexport const script = (url, el = document.createElement(\"object\")) =>\n    el.tagName === \"OBJECT\"\n        ? object(url, el)\n        : new Promise((resolve, reject) => {\n              el.onload = resolve;\n              el.onerror = reject;\n\n              el.src = url;\n              el.async = true;\n\n              document.head.append(el);\n          });\n","export default () => {\n    onmessage = async event => {\n        let data = event.data;\n\n        try {\n            const response = await fetch(data.url);\n            const blob = await response.blob();\n\n            data.response = {\n                url: response.url,\n                status: response.status,\n                statusText: response.statusText\n            };\n\n            data.blob = blob;\n        } catch (e) {\n            data.response = {\n                url: data.url,\n                status: 200\n            };\n\n            data.blob = { type: null };\n        }\n\n        postMessage(data);\n    };\n};\n","import {\n    parseUrl,\n    urlFromDataObject,\n    getLoaderTypeFromUrl,\n    isCORSUrl\n} from \"./loader.utils.mjs\";\nimport * as Loaders from \"./loader.loaders.mjs\";\nimport worker from \"./loader.worker.mjs\";\n\nexport class Loader {\n    /**\n     *\n     * @param {object} options\n     */\n    constructor(options = {}) {\n        this.worker = new Worker(\n            URL.createObjectURL(\n                new Blob([\"(\", worker.toString(), \")()\"], {\n                    type: \"application/javascript\"\n                })\n            )\n        );\n\n        this._options = { ...options, ...{} };\n    }\n\n    /**\n     * @param {string} url\n     * @returns {Promise}\n     */\n    fetch(url) {\n        const parsedUrl = parseUrl(url);\n\n        url = parsedUrl.href;\n\n        return new Promise((resolve, reject) => {\n            try {\n                if (isCORSUrl(parsedUrl)) {\n                    const type = getLoaderTypeFromUrl(url);\n\n                    const defaultData = {\n                        response: {\n                            url: url,\n                            status: 200\n                        },\n                        blob: {\n                            type: null\n                        }\n                    };\n\n                    if (type in Loaders) {\n                        return Loaders[type](url)\n                            .then(() => resolve(defaultData))\n                            .catch(reject);\n                    }\n\n                    resolve(defaultData);\n\n                    return;\n                }\n\n                this.worker.postMessage({\n                    url: url\n                });\n\n                this.worker.addEventListener(\"message\", event => {\n                    const data = event.data;\n\n                    if (data.url !== url) {\n                        return;\n                    }\n\n                    if (data.response.status !== 200) {\n                        reject(\n                            new Error(\n                                `${data.response.statusText} ${data.response.url}`\n                            )\n                        );\n\n                        return;\n                    }\n\n                    resolve(data);\n                });\n            } catch (e) {\n                reject(e);\n            }\n        });\n    }\n\n    /**\n     *\n     * @param data\n     * @param el\n     */\n    static adoptStyleSheet(data) {\n        const url = urlFromDataObject(data);\n\n        return Loaders.style(url, document).finally(() =>\n            URL.revokeObjectURL(url)\n        );\n    }\n\n    /**\n     *\n     * @param data\n     */\n    static insertScript(data) {\n        const url = urlFromDataObject(data);\n\n        return Loaders.script(\n            url,\n            document.createElement(\"script\")\n        ).finally(() => URL.revokeObjectURL(url));\n    }\n\n    /**\n     *\n     * @param data\n     * @param el\n     * @param name\n     */\n    static setImageAttribute(data, el, name = \"src\") {\n        const url = urlFromDataObject(data);\n\n        return Loaders.image(url, name, el).finally(() =>\n            URL.revokeObjectURL(url)\n        );\n    }\n}\n\nconst loader = new Loader();\n\n[...document.querySelectorAll(\"img[data-src]\")].forEach(el =>\n    loader\n        .fetch(el.dataset.src)\n        .then(x => Loader.setImageAttribute(x, el))\n        .catch(e => console.error(e))\n);\n\nloader\n    .fetch(\"dist/styles.css\")\n    .then(x => Loader.adoptStyleSheet(x))\n    .catch(e => console.error(e));\n\nloader\n    .fetch(\"dist/extra.css\")\n    .then(x => Loader.adoptStyleSheet(x))\n    .catch(e => console.error(e));\n\nloader\n    .fetch(\"dist/scripts.js\")\n    .then(x => Loader.insertScript(x))\n    .catch(e => console.error(e));\n\nloader\n    .fetch(\"dist/not-existent.js\")\n    .then(x => Loader.insertScript(x))\n    .catch(e => console.error(e));\n"],"file":"loader.min.js"}