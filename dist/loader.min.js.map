{"version":3,"sources":["src/loader.utils.mjs","src/loader.resource.mjs","src/loader.loaders.mjs","src/loader.worker.mjs","src/loader.fetch.mjs","src/loader.load.mjs","src/loader.mjs"],"names":["global","factory","exports","module","define","amd","self","Loader","this","prop","o","p","split","reduce","xs","x","getURL","arg","a","document","createElement","href","URL","isSupportedElement","el","HTMLImageElement","HTMLPictureElement","HTMLSourceElement","HTMLVideoElement","HTMLAudioElement","isCORS","hostname","window","location","protocol","collection","WeakMap","build","data","url","blob","LoaderResource","[object Object]","override","has","get","set","Loaders","image","bool","Image","Promise","resolve","reject","onload","onerror","src","loadImage","script","async","head","append","loadScript","width","height","body","loadObject","style","sheet","CSSStyleSheet","promise","replace","adoptedStyleSheets","loadStyle","work","onmessage","event","message","response","fetch","options","status","statusText","e","postMessage","worker","loaderWorker","createObjectURL","Blob","toString","type","Worker","revokeObjectURL","createWorker","collection$1","_fetch","resource","cors","_load","addEventListener","Error","pop","trim","getLoaderType","finally","NodeList","Array","isArray","map","isLoaderResource","load"],"mappings":"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","sourcesContent":["/**\n *\n * @param {Object} o\n * @param {String} p\n */\nexport const prop = (o, p) =>\n    p.split(\".\").reduce((xs, x) => (xs && xs[x] ? xs[x] : null), o);\n\n/**\n *\n * @param {String|LoaderResource} url\n * @returns {URL}\n */\nexport const getURL = arg => {\n    arg = prop(arg, \"url\") || arg;\n    arg = prop(arg, \"href\") || arg;\n\n    const a = document.createElement(\"a\");\n    a.href = arg;\n\n    return new URL(a);\n};\n\n/**\n *\n * @param {HTMLElement} el\n * @returns {Boolean}\n */\nexport const isSupportedElement = el => {\n    return (\n        el instanceof HTMLImageElement ||\n        el instanceof HTMLPictureElement ||\n        el instanceof HTMLSourceElement ||\n        el instanceof HTMLVideoElement ||\n        el instanceof HTMLAudioElement\n    );\n};\n\n/**\n *\n * @param {Function} work\n * @returns {Worker}\n */\nexport const createWorker = work => {\n    work = typeof work !== \"function\" ? () => {} : work;\n\n    const url = URL.createObjectURL(\n        new Blob([\"(\", work.toString(), \")()\"], {\n            type: \"application/javascript\"\n        })\n    );\n\n    const worker = new Worker(url);\n\n    URL.revokeObjectURL(url);\n\n    return worker;\n};\n\n/**\n *\n * @param {String|LoaderResource} arg\n */\nexport const getLoaderType = arg => {\n    arg = getURL(arg)\n        .href.split(/\\#|\\?/)[0]\n        .split(\".\")\n        .pop()\n        .trim();\n\n    switch (arg) {\n        case \"jpg\":\n        case \"jpe\":\n        case \"jpeg\":\n        case \"jif\":\n        case \"jfi\":\n        case \"jfif\":\n        case \"gif\":\n        case \"tif\":\n        case \"tiff\":\n        case \"bmp\":\n        case \"dib\":\n        case \"webp\":\n        case \"ico\":\n        case \"cur\":\n        case \"svg\":\n        case \"png\":\n            return \"image\";\n        case \"css\":\n            return \"style\";\n        case \"js\":\n        case \"mjs\":\n            return \"script\";\n        /*case \"mp3\":\n        case \"ogg\":\n        case \"oga\":\n        case \"spx\":\n        case \"ogg\":\n        case \"wav\":\n        case \"mp4\":\n        case \"ogg\":\n        case \"ogv\":\n        case \"webm\":\n            return \"media\";*/\n        default:\n            return null;\n    }\n};\n\n/**\n *\n * @param {URL|String|LoaderResource} arg\n * @returns {Boolean}\n */\nexport const isCORS = arg => {\n    arg = getURL(arg);\n\n    return (\n        arg.hostname !== window.location.hostname ||\n        arg.protocol !== window.location.protocol\n    );\n};\n","import { getURL, prop, isSupportedElement } from \"./loader.utils.mjs\";\n\n// ...\nconst collection = new WeakMap();\n\n// ...\nconst build = data => {\n    let o = {};\n\n    if (isSupportedElement(data)) {\n        o.el = data;\n        o.url = getURL(prop(o.el, \"dataset.src\")); // TODO: find a way to get currentSrc without triggering load\n    } else {\n        o.el = prop(data, \"el\");\n        o.url = data instanceof URL ? data : prop(data, \"url\");\n    }\n\n    o.blob = prop(data, \"blob\");\n\n    return o;\n};\n\n// ...\n// TODO: refactor to avoid \"override\" param\nexport default class LoaderResource {\n    constructor(data, override) {\n        let o = build(data);\n\n        if (collection.has(o.url) && !override) {\n            o = collection.get(o.url);\n        }\n\n        if (collection.has(o.el) && !override) {\n            o = collection.get(o.el);\n        }\n\n        this.el = o.el;\n        this.url = o.url;\n        this.blob = o.blob;\n\n        collection.set(o.el || o.url, this);\n    }\n\n    static isLoaderResource(data) {\n        return data instanceof this;\n    }\n}\n","export const loadImage = (url, el = new Image()) =>\n    new Promise((resolve, reject) => {\n        el.onload = () => resolve(el);\n        el.onerror = reject;\n\n        el.src = url;\n    });\n\n/* export const loadMedia = (url, el = new Image()) =>\n    // TODO:\n    new Promise((resolve, reject) => {\n        el.onload = () => resolve(el);\n        el.onerror = reject;\n\n        el.src = url;\n    }); */\n\nexport const loadStyle = (url, el = document.createElement(\"div\")) => {\n    const sheet = new CSSStyleSheet();\n\n    const promise = sheet.replace(`@import url(\"${url}\")`);\n\n    if (\"adoptedStyleSheets\" in el) {\n        el.adoptedStyleSheets = [...el.adoptedStyleSheets, sheet];\n    }\n\n    return promise;\n};\n\nexport const loadObject = (url, el = document.createElement(\"object\")) =>\n    new Promise((resolve, reject) => {\n        // TODO: check\n        el.onload = () => resolve(el);\n        el.onerror = reject;\n\n        el.data = url;\n\n        el.width = 0;\n        el.height = 0;\n\n        document.body.append(el);\n    });\n\nexport const loadScript = (url, el = document.createElement(\"script\")) =>\n    new Promise((resolve, reject) => {\n        // TODO: check\n        el.onload = () => resolve(el);\n        el.onerror = reject;\n\n        el.src = url;\n        el.async = true;\n\n        document.head.append(el);\n    });\n\nexport default {\n    image: (url, bool, el) => loadImage(url, bool ? el : void 0),\n    // media: (url, bool, el) => loadMedia(url, bool ? el : void 0),\n    script: (url, bool) => (bool ? loadScript(url) : loadObject(url)),\n    style: (url, bool) => loadStyle(url, bool ? document : void 0)\n};\n","import { createWorker } from \"./loader.utils.mjs\";\n\nexport const work = () => {\n    onmessage = async event => {\n        const data = event.data;\n\n        // ...\n        let message;\n        try {\n            const response = await fetch(data.href, data.options);\n            const blob = await response.blob();\n\n            message = {\n                status: response.status,\n                statusText: response.statusText,\n                blob: blob\n            };\n        } catch (e) {\n            message = {\n                status: 0,\n                statusText: e\n            };\n        }\n\n        // ...\n        message.href = data.href;\n        postMessage(message);\n    };\n};\n\nlet worker = null;\nexport default () => {\n    // ...\n    if (worker) {\n        return worker;\n    }\n\n    // ...\n    return (worker = createWorker(work));\n};\n","import { isCORS } from \"./loader.utils.mjs\";\nimport _load from \"./loader.load.mjs\";\nimport loaderWorker from \"./loader.worker.mjs\";\nimport LoaderResource from \"./loader.resource.mjs\";\n\n// ...\nconst collection = {};\n\n/**\n *\n * @param {LoaderResource} resource\n * @param {Object} options\n */\nexport default async (resource, options = {}) => {\n    // ...\n    if (resource.url.href in collection) {\n        const el = resource.el;\n\n        resource = await collection[resource.url.href];\n\n        return new LoaderResource({ ...resource, ...{ el: el } }, true);\n    }\n\n    // ...\n    if (isCORS(resource) && options.fetch.cors !== \"no-cors\") {\n        return (collection[resource.url.href] = _load(\n            resource,\n            options,\n            false\n        ));\n    }\n\n    // ...\n    return (collection[resource.url.href] = new Promise((resolve, reject) => {\n        const worker = loaderWorker();\n\n        // ...\n        worker.postMessage({\n            href: resource.url.href,\n            options: options.fetch\n        });\n\n        // ...\n        worker.addEventListener(\"message\", event => {\n            const data = event.data;\n\n            // ...\n            if (data.href !== resource.url.href) {\n                return;\n            }\n\n            // ...\n            if (data.status === 200) {\n                resource = new LoaderResource(\n                    { ...resource, ...{ blob: data.blob } },\n                    true\n                );\n\n                resolve(resource);\n\n                return;\n            }\n\n            // ...\n            reject(new Error(`${data.statusText} ${data.href}`));\n        });\n    }));\n};\n","import Loaders from \"./loader.loaders.mjs\";\nimport _fetch from \"./loader.fetch.mjs\";\nimport { getLoaderType, isCORS } from \"./loader.utils.mjs\";\n\n/**\n *\n * @param {LoaderResource} resource\n * @param {Object} options\n */\nexport default async (resource, options, bool) => {\n    // ...\n    if (!isCORS(resource) || options.fetch.cors === \"no-cors\") {\n        const el = resource.el;\n\n        resource = await _fetch(resource, options);\n\n        resource.el = el;\n    }\n\n    // ...\n    const type = getLoaderType(resource);\n    if (!(type in Loaders)) {\n        throw new Error(\"invalid type\");\n    }\n\n    // ...\n    const url = !!resource.blob\n        ? URL.createObjectURL(resource.blob)\n        : resource.url.href;\n\n    // ...\n    await Loaders[type](url, bool, resource.el).finally(() =>\n        URL.revokeObjectURL(url)\n    );\n\n    return resource;\n};\n","import { getURL, isSupportedElement } from \"./loader.utils.mjs\";\nimport LoaderResource from \"./loader.resource.mjs\";\nimport _load from \"./loader.load.mjs\";\nimport _fetch from \"./loader.fetch.mjs\";\n\nexport default class Loader {\n    constructor(options) {\n        // this way fetch throws but you don't get double download\n        // TODO: check if opt makes sense\n        this.options = {\n            ...{ fetch: { cors: \"no-cors\" } },\n            ...options\n        };\n    }\n\n    /**\n     *\n     * @param {String|Array|LoaderResource|HTMLElement|NodeList} arg\n     * @returns {Array|Promise}\n     */\n    fetch(arg) {\n        // ...\n        if (arg instanceof NodeList) {\n            return this.fetch([...arg]);\n        }\n\n        // ...\n        if (Array.isArray(arg)) {\n            return arg.map(a => this.fetch(a));\n        }\n\n        // ...\n        if (typeof arg === \"string\") {\n            return this.fetch(getURL(arg));\n        }\n\n        // ...\n        if (isSupportedElement(arg) || arg instanceof URL) {\n            return this.fetch(new LoaderResource(arg));\n        }\n\n        // ...\n        if (LoaderResource.isLoaderResource(arg)) {\n            return _fetch(arg, this.options);\n        }\n\n        // ...\n        return Promise.reject(new Error(\"invalid argument\"));\n    }\n\n    /**\n     * @param {String|Array|LoaderResource|HTMLElement|NodeList|URL} arg\n     * @returns {Array|Promise}\n     */\n    load(arg) {\n        if (arg instanceof NodeList) {\n            return this.load([...arg]);\n        }\n\n        // ...\n        if (Array.isArray(arg)) {\n            return arg.map(a => this.load(a));\n        }\n\n        // ...\n        if (typeof arg === \"string\") {\n            return this.load(getURL(arg));\n        }\n\n        // ...\n        if (isSupportedElement(arg) || arg instanceof URL) {\n            return this.load(new LoaderResource(arg));\n        }\n\n        // ...\n        if (LoaderResource.isLoaderResource(arg)) {\n            return _load(arg, this.options, true);\n        }\n\n        // ...\n        return Promise.reject(new Error(\"invalid argument\"));\n    }\n}\n"],"file":"loader.min.js"}